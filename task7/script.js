let posts = [
    {
        id: '1',
        description: 'test1',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash', 'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '2',
        description: 'test2',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash', 'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '3',
        description: 'test3',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash', 'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '4',
        description: 'test4',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash', 'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '5',
        description: 'test5',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash', 'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '6',
        description: 'test6',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash', 'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '7',
        description: 'test7',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash', 'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '8',
        description: 'test8',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash', 'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '9',
        description: 'test9',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '10',
        description: 'test10',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '11',
        description: 'test11',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Mr. Snow',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '12',
        description: 'test12',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Mr. Snow',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '13',
        description: 'test13',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Mr. Snow',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '14',
        description: 'test14',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '15',
        description: 'Mr. Snow',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Mr. Snow',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '16',
        description: 'Mr. Snow',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Mr. Snow',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '17',
        description: 'test17',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '18',
        description: 'test18',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '19',
        description: 'test19',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '20',
        description: 'test20',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash', 'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
];

class PostCollection {

    _posts;

    constructor(posts) {
        this._posts = [];
        this.addAll(posts);
    }

    _postSchema = {
        id: val => typeof val === 'string' && val.length > 0,
        description: val => typeof val === 'string' && val.length < 200,
        createdAt: val => Object.prototype.toString.call(val) === '[object Date]',
        author: val => typeof val === 'string' && val.length > 0,
        photoLink: val => typeof val === 'string',
        hashTags: val => Array.isArray(val),
        likes: val => Array.isArray(val)
    };

    validatePost(post) {
        if(this._posts.find(p => post.id === p.id) != null) {
            console.log('this id already exist');
            return false;
        }
        if ((Math.abs(Object.keys(post).length - Object.keys(this._postSchema).length) === 1 && post['photoLink'] != null)
            || Math.abs(Object.keys(post).length - Object.keys(this._postSchema).length) > 1) {
            console.log('illegal arguments number');
            return false;
        }
        return this._validateForm(post);
    }

    _validateForm(form) {
        let errors = Object.keys(form)
            .filter(key => !this._postSchema[key]?.(form[key]))
            .map(key => new Error(key + ' is invalid!'));
        if (errors.length > 0) {
            errors.forEach(error => console.log(error.message));
            return false;
        }
        return true;
    }

    addPost(post) {
        if (this.validatePost(post)) {
            this._posts.push(post);
            return true;
        }
        return false;
    }

    removePost(id) {
        let startLength = this._posts.length;
        this._posts = this._posts.filter(post => post.id !== id);
        return startLength !== this._posts.length;
    }

    getPost(id) {
        return this._posts.find(post => post.id === id);
    }

    getPage(skip = 0, top = 10, filterConfig) {
        if (filterConfig != null) {
            return this._posts.filter(p => (filterConfig['author'] == null || p.author === filterConfig['author']) &&
                (filterConfig['fromDate'] == null || p.createdAt >= filterConfig['fromDate']) &&
                (filterConfig['toDate'] == null || p.createdAt <= filterConfig['toDate']) &&
                (filterConfig['tags'] == null || filterConfig['tags'].filter(tag => p.hashTags.includes(tag)).length === filterConfig['tags'].length))
                .slice(skip, skip + top).sort(a => a.createdAt.getDate());
        }
        return this._posts.slice(skip, skip + top).sort(a => a.createdAt.getDate());
    }

    editPost(id, form) {
        let postToEdit = this._posts.find(post => post.id === id);
        if (form != null && form.id == null && form.author == null && this._validateForm(form)) {
            Object.keys(form).forEach(key => {
                postToEdit[key] = form[key];
            });
            return true;
        }
        return false;
    }

    addAll(posts) {
        return posts.filter(post => !this.addPost(post));
    }

    clear() {
        this._posts = [];
    }

}

//Tests
let postCollection = new PostCollection(posts);
console.log(postCollection.addAll([{
    id: '18',
    description: 'test18',
    createdAt: new Date('2020-03-17T23:00:00'),
    author: 'Какой-то пользователь',
    photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
    hashTags: [
        'tag'
    ],
    likes: [
        'Другой пользователь'
    ]
},
    {
        id: '19',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: '',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '21',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash', 'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '22',
        description: 'test22',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash', 'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '23',
        description: 'test22',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash', 'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    }]));
console.log(postCollection.getPage(20,10));
postCollection.clear();
console.log(postCollection.getPage());
