let posts = [
    {
        id: '1',
        description: 'test1',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash','tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '2',
        description: 'test2',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash','tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '3',
        description: 'test3',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash','tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '4',
        description: 'test4',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash','tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '5',
        description: 'test5',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash','tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '6',
        description: 'test6',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash','tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '7',
        description: 'test7',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash','tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '8',
        description: 'test8',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash','tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '9',
        description: 'test9',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '10',
        description: 'test10',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '11',
        description: 'test11',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Mr. Snow',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '12',
        description: 'test12',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Mr. Snow',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '13',
        description: 'test13',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Mr. Snow',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '14',
        description: 'test14',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '15',
        description: 'Mr. Snow',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Mr. Snow',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '16',
        description: 'Mr. Snow',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Mr. Snow',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '17',
        description: 'test17',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '18',
        description: 'test18',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '19',
        description: 'test19',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
    {
        id: '20',
        description: 'test20',
        createdAt: new Date('2020-03-17T23:00:00'),
        author: 'Какой-то пользователь',
        photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
        hashTags: [
            'hash','tag'
        ],
        likes: [
            'Другой пользователь'
        ]
    },
]

let api = (function() {
    let postSchema = {
        id: val => typeof val === 'string' && val.length > 0,
        description: val => typeof val === 'string' && val.length < 200,
        createdAt: val => Object.prototype.toString.call(val) === '[object Date]',
        author: val => typeof val === 'string' && val.length > 0,
        photoLink: val => typeof val === 'string',
        hashTags: val => Array.isArray(val),
        likes: val => Array.isArray(val)
    };

    function validatePost(post) {
        if((Math.abs(Object.keys(post).length - Object.keys(postSchema).length) == 1 && post['photoLink'] != null)
            || Math.abs(Object.keys(post).length - Object.keys(postSchema).length) > 1) {
            console.log('illegal arguments number');
            return false;
        }
        return validateForm(post);
    };

    function validateForm(form) {
        let errors = Object.keys(form)
            .filter(key => !postSchema[key]?.(form[key]))
            .map(key => new Error(key + ' is invalid!'));
        if(errors.length > 0) {
            errors.forEach(error => console.log(error.message))
            return false;
        }
        return true;
    }

    function addPost(post) {
        if(validatePost(post) && posts.find(p => post.id === p.id) == null) {
            posts.push(post);
            return true;
        }
        return false;
    }
    
    function removePost(id) {
        let startLength = posts.length;
        posts = posts.filter(post => post.id !== id);
        return startLength != posts.length;
    }
    
    function getPost(id) {
        return posts.find(post => post.id == id);
    }

    function getPosts(skip = 0, top = 10, filterConfig) {
        if(filterConfig != null) {
            return posts.filter(p => (filterConfig.author == null || p.author === filterConfig.author) &&
                (filterConfig.fromDate == null || p.createdAt >= filterConfig.fromDate) &&
                (filterConfig.toDate == null || p.createdAt <= filterConfig.toDate) &&
                (filterConfig.tags == null || filterConfig.tags.filter(tag => p.hashTags.includes(tag)).length === filterConfig.tags.length))
                .slice(skip, skip + top).sort(a => a.createdAt);
        }
        return posts.slice(skip, skip + top).sort(a => a.createdAt);
    }

    function editPost(id, form) {
        let postToEdit = posts.find(post => post.id == id);
        if(form != null && form.id == null && form.author == null && validateForm(form)){
            Object.keys(form).forEach(key => {
                postToEdit[key] = form[key];
            })
            return true;
        }
        return false;
    }

    return {
        validatePost: validatePost,
        addPost: addPost,
        removePost: removePost,
        getPosts: getPosts,
        getPost: getPost,
        editPost: editPost
    }
}());

//Tests
console.log(api.getPosts(0, 10));
console.log(api.getPosts(10, 10));
console.log(api.getPosts(0, 10, {author: 'Mr. Snow'}));
console.log('author: какой-то пользователь, tags: tag');
console.log(api.getPosts(0,10,{author: 'Какой-то пользователь', tags: ['hash']}));
console.log('author: какой-то пользователь, tags: hash');
console.log(api.getPosts(0,10,{author: 'Какой-то пользователь', tags: ['tag']}));
console.log('author: какой-то пользователь, tags: hash tag');
console.log(api.getPosts(0,10,{author: 'Какой-то пользователь', tags: ['hash tag']}));
console.log('add post with id 20')
console.log(api.addPost({
    id: '20',
    description: 'test20',
    createdAt: new Date('2020-03-17T23:00:00'),
    author: 'Какой-то пользователь',
    photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
    hashTags: [
        'hash','tag'
    ],
    likes: [
        'Другой пользователь'
    ]
}));
console.log('add illegal post with id 21');
console.log(api.addPost({
    id: '21',
    description: 2,
    createdAt: new Date('2020-03-17T23:00:00'),
    author: '',
    photoLink: 'https://m2bob-forum.net/wcf/images/avatars/3e/2720-3e546be0b0701e0cb670fa2f4fcb053d4f7e1ba5.jpg',
    hashTags: [
        'hash','tag'
    ],
    likes: [
        'Другой пользователь'
    ]
}));
console.log('add legal post without photolink');
console.log(api.addPost({
    id: '21',
    description: 'photo link',
    createdAt: new Date('2020-03-17T23:00:00'),
    author: 'photo link',
    hashTags: [
        'hash','tag'
    ],
    likes: [
        'Другой пользователь'
    ]
}));
console.log('get post with id 21');
console.log(api.getPost('21'));
console.log('edit post with id 21');
api.editPost(api.editPost(21, {
    description: 'new description',
    createdAt: new Date('2020-03-17T23:00:00'),
    hashTags: [
        'hash','tag'
    ],
    likes: [
        'Другой пользователь'
    ]
}));
console.log(api.getPost('21'));
console.log('remove post with id 7');
console.log(api.removePost('7'));
console.log(api.getPosts());
